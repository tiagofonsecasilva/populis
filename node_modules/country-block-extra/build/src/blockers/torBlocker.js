"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const isIp = require("is-ip");
const isIpPrivate = require("private-ip");
const blocker_1 = require("./blocker");
/**
 * Express middleware to block either based on country or (optionally) on Tor access.
 */
class TorBlocker extends blocker_1.Blocker {
    /**
     * @param {ITorBlockerConfig} config  Configuration to use, shared access.
     */
    constructor(config) {
        super(config);
        this.config = config;
    }
    /**
     * The route function of this middleware, to be used in the Express instance.
     * @param {e.Request} req  Request to intercept and check.
     * @param {e.Response} res  Response to use for rejection, if necessary.
     * @param {e.NextFunction} next  Next function to call if rejection ddidn't happen.
     * @returns {Promise<void>}  Completes one the checks have been executed.
     */
    check(req, res, next) {
        return __awaiter(this, void 0, void 0, function* () {
            if (isIpPrivate(req.ip)) {
                next();
                return;
            }
            if (!isIp.v4(req.ip)) {
                if (this.config.lenient) {
                    next();
                }
                else {
                    this.reject(req, res, `request address must be IPv4: ${req.ip}`);
                }
                return;
            }
            const server = this.config.server;
            const serverIp = isIp.v4(server.host) ? server.host : yield blocker_1.dnsLookup(server.host);
            if (serverIp === undefined) {
                if (this.config.lenient) {
                    next();
                }
                else {
                    this.reject(req, res, `cannot resolve server host "${server.host}"`);
                }
                return;
            }
            const reverseIP = (expr) => expr.split(".").reverse().join(".");
            const torView = `${reverseIP(req.ip)}.${server.port}.${reverseIP(serverIp)}.ip-port.exitlist.torproject.org`;
            const torAddr = yield blocker_1.dnsLookup(torView);
            if ("127.0.0.2" === torAddr) {
                this.reject(req, res, `Tor detected for ${req.ip}`);
                return;
            }
            next();
        });
    }
}
exports.TorBlocker = TorBlocker;
//# sourceMappingURL=torBlocker.js.map